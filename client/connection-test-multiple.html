<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple Connection Tests</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #log { background: #f8f9fa; padding: 10px; border-radius: 5px; height: 400px; overflow-y: auto; }
        .connection-test { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .test-results { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ðŸ”§ Multiple Connection Tests</h1>
    
    <div class="connection-test">
        <h3>1. Simple Socket.IO Test</h3>
        <button onclick="testSimpleSocketIO()">Test Simple Socket.IO</button>
        <div id="simple-socketio-result" class="test-results"></div>
    </div>

    <div class="connection-test">
        <h3>2. WebSocket Test</h3>
        <button onclick="testWebSocket()">Test WebSocket</button>
        <div id="websocket-result" class="test-results"></div>
    </div>

    <div class="connection-test">
        <h3>3. Connection Manager Test</h3>
        <button onclick="testConnectionManager()">Test Connection Manager</button>
        <div id="connection-manager-result" class="test-results"></div>
    </div>

    <div class="connection-test">
        <h3>4. Fallback Test</h3>
        <button onclick="testFallback()">Test Fallback Strategy</button>
        <div id="fallback-result" class="test-results"></div>
    </div>

    <button onclick="clearLog()">Clear Log</button>
    <div id="log"></div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        let simpleSocket = null;
        let ws = null;
        let connectionManagerSocket = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        // 1. Simple Socket.IO Test
        async function testSimpleSocketIO() {
            log('ðŸ”Œ Testing Simple Socket.IO connection...', 'info');
            updateResult('simple-socketio-result', 'Testing...', 'info');

            try {
                if (simpleSocket?.connected) {
                    simpleSocket.disconnect();
                }

                simpleSocket = io('http://localhost:3001', {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    forceNew: true,
                    reconnection: false
                });

                const connected = await new Promise((resolve) => {
                    simpleSocket.on('connect', () => {
                        log('âœ… Simple Socket.IO connected!', 'success');
                        updateResult('simple-socketio-result', 'âœ… Connected successfully!', 'success');
                        resolve(true);
                    });

                    simpleSocket.on('connect_error', (error) => {
                        log(`âŒ Simple Socket.IO error: ${error.message}`, 'error');
                        updateResult('simple-socketio-result', `âŒ Error: ${error.message}`, 'error');
                        resolve(false);
                    });

                    setTimeout(() => {
                        if (!simpleSocket.connected) {
                            log('â° Simple Socket.IO timeout', 'warning');
                            updateResult('simple-socketio-result', 'â° Connection timeout', 'warning');
                            resolve(false);
                        }
                    }, 10000);
                });

                return connected;
            } catch (error) {
                log(`âŒ Simple Socket.IO test failed: ${error.message}`, 'error');
                updateResult('simple-socketio-result', `âŒ Test failed: ${error.message}`, 'error');
                return false;
            }
        }

        // 2. WebSocket Test
        async function testWebSocket() {
            log('ðŸ”Œ Testing WebSocket connection...', 'info');
            updateResult('websocket-result', 'Testing...', 'info');

            try {
                if (ws) {
                    ws.close();
                }

                ws = new WebSocket('ws://localhost:3001');

                const connected = await new Promise((resolve) => {
                    ws.onopen = () => {
                        log('âœ… WebSocket connected!', 'success');
                        updateResult('websocket-result', 'âœ… Connected successfully!', 'success');
                        resolve(true);
                    };

                    ws.onerror = (error) => {
                        log(`âŒ WebSocket error: ${error}`, 'error');
                        updateResult('websocket-result', 'âŒ Connection error', 'error');
                        resolve(false);
                    };

                    ws.onclose = (event) => {
                        log(`âŒ WebSocket closed: ${event.code} - ${event.reason}`, 'error');
                        updateResult('websocket-result', `âŒ Closed: ${event.code}`, 'error');
                        resolve(false);
                    };

                    setTimeout(() => {
                        if (ws.readyState === WebSocket.CONNECTING) {
                            log('â° WebSocket timeout', 'warning');
                            updateResult('websocket-result', 'â° Connection timeout', 'warning');
                            resolve(false);
                        }
                    }, 10000);
                });

                return connected;
            } catch (error) {
                log(`âŒ WebSocket test failed: ${error.message}`, 'error');
                updateResult('websocket-result', `âŒ Test failed: ${error.message}`, 'error');
                return false;
            }
        }

        // 3. Connection Manager Test
        async function testConnectionManager() {
            log('ðŸ”Œ Testing Connection Manager...', 'info');
            updateResult('connection-manager-result', 'Testing...', 'info');

            try {
                if (connectionManagerSocket?.connected) {
                    connectionManagerSocket.disconnect();
                }

                connectionManagerSocket = io('http://localhost:3001', {
                    transports: ['polling'],
                    timeout: 10000,
                    forceNew: true,
                    reconnection: false
                });

                const connected = await new Promise((resolve) => {
                    connectionManagerSocket.on('connect', () => {
                        log('âœ… Connection Manager (polling) connected!', 'success');
                        updateResult('connection-manager-result', 'âœ… Connected via polling!', 'success');
                        resolve(true);
                    });

                    connectionManagerSocket.on('connect_error', (error) => {
                        log(`âŒ Connection Manager error: ${error.message}`, 'error');
                        updateResult('connection-manager-result', `âŒ Error: ${error.message}`, 'error');
                        resolve(false);
                    });

                    setTimeout(() => {
                        if (!connectionManagerSocket.connected) {
                            log('â° Connection Manager timeout', 'warning');
                            updateResult('connection-manager-result', 'â° Connection timeout', 'warning');
                            resolve(false);
                        }
                    }, 10000);
                });

                return connected;
            } catch (error) {
                log(`âŒ Connection Manager test failed: ${error.message}`, 'error');
                updateResult('connection-manager-result', `âŒ Test failed: ${error.message}`, 'error');
                return false;
            }
        }

        // 4. Fallback Test
        async function testFallback() {
            log('ðŸ”Œ Testing Fallback Strategy...', 'info');
            updateResult('fallback-result', 'Testing...', 'info');

            const methods = [
                { name: 'Socket.IO', test: testSimpleSocketIO },
                { name: 'WebSocket', test: testWebSocket },
                { name: 'Polling', test: testConnectionManager }
            ];

            for (const method of methods) {
                log(`ðŸ”„ Trying ${method.name}...`, 'info');
                const connected = await method.test();
                
                if (connected) {
                    log(`âœ… ${method.name} worked!`, 'success');
                    updateResult('fallback-result', `âœ… Connected via ${method.name}!`, 'success');
                    return true;
                } else {
                    log(`âŒ ${method.name} failed, trying next...`, 'warning');
                }
            }

            log('âŒ All connection methods failed', 'error');
            updateResult('fallback-result', 'âŒ All methods failed', 'error');
            return false;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Auto-test on page load
        window.addEventListener('load', () => {
            log('ðŸš€ Page loaded, ready to test connections...');
        });
    </script>
</body>
</html> 